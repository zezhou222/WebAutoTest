<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/static/bootstrap-3.3.7-dist/css/bootstrap.css">
</head>
<body>

<div class="container-fluid" style="padding: 10px 30px;">
    <div class="row">
        <h5 class="text-center"><b>用例名称：</b>{{ uc_obj.name }}</h5>
        <h5 class="text-center"><b>用例描述：</b>{{ uc_obj.desc }}</h5>
    </div>
    <div class="row">
        <button type="button" class="btn btn-default pull-right" id="refresh_page">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
        </button>
    </div>
    <div class="row">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <td width="50">序号</td>
                <td>执行状态</td>
                <td>开始时间</td>
                <td>结束时间</td>
                <td>操作</td>
            </tr>
            </thead>
            <tbody>
            {% for obj in result_objs %}
                <tr>
                    <td>{{ loop.index }}</td>
                    {% if obj.status == 'executing' %}
                        <td style="color: #0000e6">{{ obj.status }}</td>
                    {% elif obj.status == 'success' %}
                        <td style="color: #00e600">{{ obj.status }}</td>
                    {% else %}
                        <td style="color: #f00000">{{ obj.status }}</td>
                    {% endif %}
                    <td>{{ obj.execute_time }}</td>
                    <td>
                    {% if obj.status != 'executing' %}
                        {{ obj.end_time }}
                    {% endif %}
                    </td>
                    <td uc_result_id="{{ obj.id }}">
                        {% if obj.status != 'executing' %}
                            <button class="btn btn-success btn-xs step_execute_desc">步骤执行详情</button>
                            {% if obj.screen_shot_flag == 1 %}
                            <button class="btn btn-success btn-xs step_screen_shot" target="_blank" uc_result_id="{{ obj.id }}">查看截图</button>
                            {% endif %}
                            <button class="btn btn-success btn-xs del_step_result">删除</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="row">
        <!-- 生成页码标签 -->
        {{ page.make_label()|safe }}
    </div>

</div>

<script src="/static/js/jquery-3.4.1.js"></script>
<script src="/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

<script src="/static/js/settings.js"></script>
<script>

    // 用例id
    var uc_id = "{{ uc_obj.id }}";

    function all_event() {
        // 点击步骤执行详情的事件
        click_step_execute_desc_event();
        // 刷新页面事件
        click_refresh_page_button_event();
        // 删除执行步骤的事件
        click_del_step_result_event();
        // 点击获取用例截图事件
        click_step_screen_shot_event();
    }

    function click_step_execute_desc_event(){

        $('tbody').on('click', '.step_execute_desc', function (e) {
            // 获取用例结果id
            var uc_result_id = $(this).parent().attr('uc_result_id');
            // 小步骤得执行结果得url
            var new_url = `${get_step_result_url}?uc_result_id=${uc_result_id}&uc_id=${uc_id}`;
            // iframe发送请求获取新页面
            $(window.parent.document).find('iframe').attr('src', new_url);
        })

    }

    function click_refresh_page_button_event(){

        $('#refresh_page').click(function (e) {
            // 刷新iframe
            $(window.parent.document).find('iframe')[0].contentWindow.location.reload();
        });

    }

    function click_del_step_result_event(){

        $('tbody').on('click', '.del_step_result', function (e) {
            // 获取用例结果id
            var uc_result_id = $(this).parent().attr('uc_result_id');
            $.ajax({
                url: get_use_case_result_url,
                type: 'delete',
                data: {'use_result_id': uc_result_id},
                success: function (response) {
                    if (response.flag == 0){
                        // 删除成功的动画

                        //刷新当前iframe请求
                        var new_url = $(window.parent.document).find('iframe').attr('src') + '?';
                        $(window.parent.document).find('iframe').attr('src', new_url);
                    }else{
                        alert(response.error_info);
                    }
                }

            });

        })

    }

    function click_step_screen_shot_event(){

        $('tbody').on('click', '.step_screen_shot',function (e) {
           var uc_result_id = $(this).attr('uc_result_id');
           var new_url = `${get_screen_shot_url}?uc_result_id=${uc_result_id}`;
           $(window.parent.document).find('iframe').attr('src', new_url);
        });

    }

    all_event();

</script>
</body>
</html>