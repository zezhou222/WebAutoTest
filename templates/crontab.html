<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/static/bootstrap-3.3.7-dist/css/bootstrap.css">

</head>
<body>


<div class="container-fluid" style="padding: 10px 30px;">

    <div class="row">

        <form id="search_form">
            <div class="col-md-3 pull-right" style="padding-left: 2px;">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="" id="search_content">
                    <span class="input-group-btn">
                        <input type="button" value="Search" class="btn btn-primary" id="search_btn">
                     </span>
                </div><!-- /input-group -->
            </div><!-- /.col-lg-6 -->

            <div class="col-md-2 pull-right" style="padding-right: 0;">

                <select name="opt" id="opt" class="form-control pull-right" style="width: 100px;">
                    <option value="all" selected>全部</option>
                    <option value="project">项目</option>
                    <option value="task_name">任务名称</option>
                </select>

            </div>
        </form>
    </div>

    <div class="row">
        <table class="table table-striped table-hover tab">
            <thead>
            <tr>
                <td width="50">序号</td>
                <td>定时任务名称</td>
                <td>项目名称</td>
                <td>测试类型</td>
                <td>测试数据</td>
                <td>任务类型</td>
                <td>执行时间</td>
                <td>任务描述</td>
                <td>操作</td>
            </tr>
            </thead>
            <tbody>
            {% for obj in crontab_objs %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ obj.task_name }}</td>
                <td>{{ obj.cron2pro.project_name }}</td>
                <td>
                    {% if obj.test_type == 'use_case_test' %}
                        用例测试
                    {% else %}
                        接口测试
                    {% endif %}
                </td>
                <td test_data_id={{ obj.test_data_id }}>
                    {{ obj.test_data }}
                </td>
                <td>
                    {% if obj.task_type == 'interval_task' %}
                        间隔执行任务
                    {% elif obj.task_type == 'once_task' %}
                        一次性任务
                    {% else %}
                        定时任务
                    {% endif %}
                </td>
                <td>
                    {{ obj.execute_time }}
                </td>
                <td>{{ obj.task_description }}</td>
                <td crontab_id="{{ obj.id }}">
                    <p>
                        <button class="btn btn-primary btn-xs edit_btn">编辑</button>
                    </p>
                    <p>
                        <button class="btn btn-danger btn-xs del_btn">删除</button>
                    </p>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- 分页器 -->
        {{ page.make_label()|safe }}
    </div>

</div>


<script src="/static/js/jquery-3.4.1.js"></script>
<script src="/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

<script src="/static/js/settings.js"></script>
<script>

    function all_event() {
        // 点击删除任务
        click_del_task_event();
        // 点击编辑用例的事件
        click_edit_task_event();
        // 搜索的事件
        click_search_btn_event();
    }

    function click_del_task_event() {

        $('.del_btn').click(function (e) {
            // 获取id
            var crontab_id = $(this).parent().parent().attr('crontab_id');

            // 发送delete请求
            $.ajax({
                url: crontab_url,
                type: 'delete',
                data: {'crontab_id': crontab_id},
                success: function (response) {
                    // 删除成功的动画效果
                    window.parent.toastr.success('删除成功!');
                    // iframe标签页面刷新
                    $(window.parent.document).find('iframe')[0].contentWindow.location.reload(true);
                },
                error: function (xhr) {
                    window.parent.toastr.error(JSON.parse(xhr.responseText)['error']);
                }

            });

        });

    }


    function click_edit_task_event() {

        $('tbody').on('click', '.edit_btn', function (e) {

            // 获取用例id
            var crontab_id = $(this).parent().parent().attr('crontab_id');
            // 拼接url
            var new_url = edit_crontab_page_url + crontab_id + '/';
            // 首页的iframe请求结果页面
            $(window.parent.document).find('iframe').attr('src', new_url)

        })

    }

    function click_search_btn_event(){

        $('#search_btn').click(function (e) {
            var opt = $('#opt').find('option:selected').val();
            var search_content = $('#search_content').val();
            var new_url = `${crontab_url}?opt=${opt}&&search_content=${search_content}`;
            // 让其请求新的url
            $(window.parent.document).find('iframe').attr('src', new_url);
        });

    }

    all_event();

</script>
</body>
</html>